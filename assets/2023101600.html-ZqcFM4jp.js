import{_ as a}from"./plugin-vue_export-helper-x3n3nnut.js";import{o as n,c as s,f as p}from"./app-5ZyUDSyM.js";const t="/assets/img-20231016003516-UYOYl3xR.png",e="/assets/img-20231016004421-2Me27_pY.png",o="/assets/img-20231016005223-lMy1YBUt.png",c="/assets/img-20231016005749--bF4W9p_.png",i="/assets/img-20231016005820-hgIGlbTL.png",l={},u=p(`<p>​</p><h2 id="背景" tabindex="-1"><a class="header-anchor" href="#背景" aria-hidden="true">#</a> 背景</h2><p>最近在做项目架构升级，并顺便升级了下基础组件。升级完之后，跑 UT 报一下异常：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Caused</span> by<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>UnsupportedOperationException</span><span class="token operator">:</span> &#39;posix<span class="token operator">:</span>permissions&#39; not supported as initial attribute
  at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span>WindowsSecurityDescriptor</span><span class="token punctuation">.</span><span class="token function">fromAttribute</span><span class="token punctuation">(</span><span class="token class-name">WindowsSecurityDescriptor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">358</span><span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span>WindowsFileSystemProvider</span><span class="token punctuation">.</span><span class="token function">createDirectory</span><span class="token punctuation">(</span><span class="token class-name">WindowsFileSystemProvider</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">509</span><span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span>Files</span><span class="token punctuation">.</span><span class="token function">createDirectory</span><span class="token punctuation">(</span><span class="token class-name">Files</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">700</span><span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span>TempFileHelper</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">TempFileHelper</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">134</span><span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span>TempFileHelper</span><span class="token punctuation">.</span><span class="token function">createTempDirectory</span><span class="token punctuation">(</span><span class="token class-name">TempFileHelper</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">171</span><span class="token punctuation">)</span>
  at java<span class="token punctuation">.</span>base<span class="token operator">/</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span>Files</span><span class="token punctuation">.</span><span class="token function">createTempDirectory</span><span class="token punctuation">(</span><span class="token class-name">Files</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">976</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>TempFileCreator</span>$<span class="token class-name">JavaNioCreator</span><span class="token punctuation">.</span><span class="token function">createTempDir</span><span class="token punctuation">(</span><span class="token class-name">TempFileCreator</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">102</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Files</span><span class="token punctuation">.</span><span class="token function">createTempDir</span><span class="token punctuation">(</span><span class="token class-name">Files</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">439</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">redis<span class="token punctuation">.</span>embedded<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>JarUtil</span><span class="token punctuation">.</span><span class="token function">extractExecutableFromJar</span><span class="token punctuation">(</span><span class="token class-name">JarUtil</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">13</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">redis<span class="token punctuation">.</span>embedded<span class="token punctuation">.</span></span>RedisExecProvider</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">RedisExecProvider</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">56</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">redis<span class="token punctuation">.</span>embedded<span class="token punctuation">.</span></span>RedisServerBuilder</span><span class="token punctuation">.</span><span class="token function">resolveConfAndExec</span><span class="token punctuation">(</span><span class="token class-name">RedisServerBuilder</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">105</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">141</span> more
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从异常栈信息里大概可以看出来，是在创建临时目录的时候进行权限校验，但不支持 &#39;posix:permissions&#39; 这个属性。</p><h2 id="分析过程" tabindex="-1"><a class="header-anchor" href="#分析过程" aria-hidden="true">#</a> 分析过程</h2><p>要分析原因，首先从源码入手。</p><figure><img src="`+t+'" alt="img-20231016003516" tabindex="0" loading="lazy"><figcaption>img-20231016003516</figcaption></figure><p>Windows 只支持 &#39;acl:acl&#39; 这种格式，并不支持 &#39;posix:permissions&#39; 这种格式。那为什么这样呢？难道没做好系统的判断？</p><figure><img src="'+e+'" alt="img-20231016004421" tabindex="0" loading="lazy"><figcaption>img-20231016004421</figcaption></figure><p>再往上溯源，定位到了 guava 的 JavaNioCreator.createTempDir 方法，确实是没有做系统的判断，直接使用了 PosixFilePermission 作为权限属性，但这个只适用于 posix 类型的系统。</p><p>Guava 是很出名的开源组件，不至于犯这种低级错误吧？不过升级以前是没这个问题的，查一下以前版本的源码应该能找到原因。</p><figure><img src="'+o+'" alt="img-20231016005223" tabindex="0" loading="lazy"><figcaption>img-20231016005223</figcaption></figure><p>这是 guava:21.0 的 com.google.common.io.Files#createTempDir 方法，可以看到以前版本只用 io 的方法创建临时目录，根本没有使用 nio 的方式。那就是说 guava:32.0.0-jre 才增加 nio 方法，且默认使用 nio 的方式。</p><p>既然 guava:32.0.0-jre 有问题，那不如看看最新版本，是否依然存在问题。</p><figure><img src="'+c+'" alt="img-20231016005749" tabindex="0" loading="lazy"><figcaption>img-20231016005749</figcaption></figure><figure><img src="'+i+'" alt="img-20231016005820" tabindex="0" loading="lazy"><figcaption>img-20231016005820</figcaption></figure><p>通过最新版本 guava:32.1.3-jre 的源码可以看出，最新版本增加了系统判断，分别支持了 &#39;posix:permissions&#39; 和 &#39;acl:acl&#39; 两种属性。</p><p>所以，最后是<strong>升级 guava:32.1.3-jre 版本</strong>后解决问题。</p><p>就算是 Google 出品的东西也存在漏洞啊，不过很快就被修复了，只是我很不凑巧地被升级到 guava:32.0.0-jre 这个有漏洞的版本。</p>',20),r=[u];function k(m,d){return n(),s("div",null,r)}const f=a(l,[["render",k],["__file","2023101600.html.vue"]]);export{f as default};
